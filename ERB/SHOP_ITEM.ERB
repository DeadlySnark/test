@ITEM_BUY
PRINTFORML {ITEMSALES:62}
CALL ITEM_SALES
PRINT_ITEM
PRINTFORML 購入するアイテムを選んでください 所持金:${MONEY}
CALL SHOW_ITEM
PRINT [100] - 戻る
$INPUT_LOOP
INPUT
IF RESULT == 100
	RETURN 0
ELSEIF ITEMSTOCK(RESULT) == 1 || ITEMSTOCK(RESULT) == 4 || LOCAL < 0 || LOCAL > 100
	RESTART
ELSEIF ITEMSTOCK(RESULT) == 2
	PRINTW 売切です
	RESTART
ELSEIF ITEMSTOCK(RESULT) == 3
	PRINTW 所持金が足りません
	RESTART
ELSEIF ITEMSTOCK(RESULT) == 5
	PRINTW 既に十分持っています
	RESTART
ENDIF
LOCAL = RESULT
;アイテムの説明
DRAWLINE
PRINTL
PRINTFORML 〜%ITEMNAME:LOCAL%〜
CALLFORM アイテム説明_{LOCAL}
PRINTL
DRAWLINE

;個別に処理すべきもの
IF LOCAL == 60 || LOCAL == 61 || LOCAL == 62
	LOCALS = %ITEMNAME:LOCAL%を習得しますか？
	CALL CHOICE(LOCALS, "はい", "いいえ")
	SIF RESULT
		RESTART
	MONEY -= ITEMPRICE:LOCAL
	SELECTCASE LOCAL
		CASE 60
			TALENT:MASTER:汚臭耐性 = 2
		CASE 61
			TALENT:MASTER:調合知識 = 1
		CASE 62
			TALENT:MASTER:禁断の知識 = 1
	ENDSELECT
	ITEMSALES:LOCAL = -1
	RESTART
ENDIF
IF LOCAL == 63
	CALL CHOICE("【技巧UP】を購入しますか？", "はい", "いいえ")
	SIF RESULT
		RESTART
	MONEY -= ITEMPRICE:LOCAL
	ABL:MASTER:技巧 += 1
	RESTART
ENDIF
IF LOCAL == 64
	CALL CHOICE("【技巧DOWN】を購入しますか？", "はい", "いいえ")
	SIF RESULT
		RESTART
	MONEY -= ITEMPRICE:LOCAL
	ABL:MASTER:技巧 -= 1
	RESTART
ENDIF
IF LOCAL == 70
	CALL CHOICE("【元気になる薬】を購入しますか？", "はい", "いいえ")
	SIF RESULT
		RESTART
	PRINTL 誰に使いますか？
	PRINTL [-1] - 戻る
	FOR LOCAL:1, 0, CHARANUM
		IF BASE:(LOCAL:1):0 < MAXBASE:(LOCAL:1):0
			PRINTFORM [{LOCAL:1}] - %CALLNAME:(LOCAL:1)% 
			CALL PRINT_BASE("体力",LOCAL:1,0,32)
			PRINTL
		ENDIF
	NEXT
	$INPUT_LOOP_70
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || BASE:RESULT:0 == MAXBASE:RESULT:0
		GOTO INPUT_LOOP_70
	ELSE
		PRINTFORMW %CALLNAME:RESULT%の体力+300
		MONEY -= ITEMPRICE:LOCAL
		BASE:RESULT:0 += 300
		SIF BASE:RESULT:0 > MAXBASE:RESULT:0
			BASE:RESULT:0 = MAXBASE:RESULT:0
	ENDIF
	RESTART
ENDIF
IF LOCAL == 71
	CALL CHOICE("【薬の材料(双)】を購入しますか？", "はい", "いいえ")
	SIF RESULT
		RESTART
	PRINTL 誰に使いますか？
	PRINTL [-1] - 戻る
	FOR LOCAL:1, 0, CHARANUM
		SIF TALENT:(LOCAL:1):2 == 1
			PRINTFORML [{LOCAL:1}] - %CALLNAME:(LOCAL:1)% 
	NEXT
	$INPUT_LOOP_71
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || TALENT:RESULT:2 != 1
		GOTO INPUT_LOOP_71
	ELSE
		PRINTFORMW %CALLNAME:RESULT%はふたなりになりました
		MONEY -= ITEMPRICE:LOCAL
		TALENT:RESULT:2 |= 2
		MAXBASE:RESULT:射精 = 10000
		IF MAXBASE:RESULT:精力 > 0
			MAXBASE:RESULT:精力 = MIN(1000,MAXBASE:RESULT:精力)
		ELSE
			MAXBASE:RESULT:精力 = 1000
		ENDIF
		IF MAXBASE:RESULT:勃起 > 0
			MAXBASE:RESULT:勃起 = MIN(1500,MAXBASE:RESULT:勃起)
		ELSE
			MAXBASE:RESULT:勃起 = MIN(1500,MAXBASE:RESULT:勃起)
		ENDIF
	ENDIF
	RESTART
ENDIF
IF LOCAL == 72
	CALL CHOICE("【薬の材料(消)】を購入しますか？", "はい", "いいえ")
	SIF RESULT
		RESTART
	PRINTL 誰に使いますか？
	PRINTL [-1] - 戻る
	FOR LOCAL:1, 0, CHARANUM
		SIF TALENT:(LOCAL:1):2 == 3
			PRINTFORML [{LOCAL:1}] - %CALLNAME:(LOCAL:1)% 
	NEXT
	$INPUT_LOOP_72
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || TALENT:RESULT:2 != 3
		GOTO INPUT_LOOP_72
	ELSE
		PRINTFORMW %CALLNAME:RESULT%は女の子になりました
		MONEY -= ITEMPRICE:LOCAL
		TALENT:RESULT:2 = 1
		MAXBASE:RESULT:2 = 0
		MAXBASE:RESULT:精力 = 0
	ENDIF
	RESTART
ENDIF
IF LOCAL == 73
	CALL CHOICE("【青いキャンディ】を購入しますか？", "はい", "いいえ")
	SIF RESULT
		RESTART
	PRINTL 誰に使いますか？
	PRINTL [-1] - 戻る
	FOR LOCAL:1, 0, CHARANUM
		SIF !TALENT:(LOCAL:1):母乳体質
			PRINTFORML [{LOCAL:1}] - %CALLNAME:(LOCAL:1)% 
	NEXT
	$INPUT_LOOP_73
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || TALENT:RESULT:149
		GOTO INPUT_LOOP_73
	ELSE
		PRINTFORMW %CALLNAME:RESULT%は[母乳体質]を得ました
		MONEY -= ITEMPRICE:LOCAL
		TALENT:RESULT:母乳体質 = 1
	ENDIF
	RESTART
ENDIF
IF LOCAL == 74
	CALL CHOICE("【赤いキャンディ】を購入しますか？", "はい", "いいえ")
	SIF RESULT
		RESTART
	PRINTL 誰に使いますか？
	PRINTL [-1] - 戻る
	FOR LOCAL:1, 0, CHARANUM
		SIF !TALENT:(LOCAL:1):0 && !TALENT:(LOCAL:1):1
			PRINTFORML [{LOCAL:1}] - %CALLNAME:(LOCAL:1)% 
	NEXT
	$INPUT_LOOP_74
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || (TALENT:RESULT:0 || TALENT:RESULT:1)
		GOTO INPUT_LOOP_74
	ELSE
		PRINTFORMW %CALLNAME:RESULT%の処女膜が再生しました
		MONEY -= ITEMPRICE:LOCAL
		TALENT:RESULT:0 = 2
	ENDIF
	RESTART
ENDIF
IF LOCAL == 77
	CALL CHOICE("【橙色のキャンディ】を購入しますか？", "はい", "いいえ")
	SIF RESULT
		RESTART
	PRINTL 誰に使いますか？
	PRINTL (※強度が高いほど一度に産む子供の数が多くなりやすくなります)
	PRINTL (※強度が６の状態で使うと０に戻ります)
	PRINTL [-1] - 戻る
	FOR LOCAL:1, 0, CHARANUM
		SIF TALENT:(LOCAL:1):2 != 2
			PRINTFORML [{LOCAL:1}] - %CALLNAME:(LOCAL:1)% (強度 {CFLAG:(LOCAL:1):355})
	NEXT
	$INPUT_LOOP_77
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || (TALENT:RESULT:0 || TALENT:RESULT:1)
		GOTO INPUT_LOOP_77
	ELSE
		IF CFLAG:RESULT:355 == 6
			CFLAG:RESULT:355 = 0
		ELSE
			CFLAG:RESULT:355 ++
		ENDIF
		PRINTFORML %CALLNAME:RESULT%は橙色のキャンディを使用しました
		PRINTFORMW 現在の強度 {CFLAG:RESULT:355}
		MONEY -= ITEMPRICE:LOCAL
	ENDIF
	RESTART
ENDIF
IF LOCAL == 91
	CALL CHOICE("【排卵誘発剤】を購入しますか？", "はい", "いいえ")
	SIF RESULT
		RESTART
		PRINTL 誰に使いますか？
	FOR LOCAL:1, 0, CHARANUM
		SIF NO:(LOCAL:1) == 149 && CFLAG:(LOCAL:1):75 < 3 && !TALENT:MASTER:禁断の知識
			CONTINUE
		SIF TALENT:(LOCAL:1):妊娠
			CONTINUE
		SIF GETBIT(TALENT:(LOCAL:1):2,0) && CFLAG:(LOCAL:1):81 != 3
			PRINTFORML [{LOCAL:1}] - %CALLNAME:(LOCAL:1)% 
	NEXT
	PRINTL [999] - 戻る
	$INPUT_LOOP_91
	INPUT
	IF RESULT == 999
		RESTART
	ELSEIF RESULT >= CHARANUM || !GETBIT(TALENT:RESULT:2,0)
		GOTO INPUT_LOOP_91
	ELSE
		PRINTFORM %CALLNAME:RESULT%
		IF RESULT == 0
			PRINTW は排卵誘発剤を飲みました
		ELSE
			PRINTW に排卵誘発剤を渡しました
		ENDIF
		MONEY -= ITEMPRICE:LOCAL
		CFLAG:RESULT:81 = 2
		TRYCALL 排卵誘発剤追加処理, RESULT
	ENDIF
	RESTART
ENDIF
IF LOCAL == 92
	CALL CHOICE("【ピル】を購入しますか？", "はい", "いいえ")
	SIF RESULT
		RESTART
		PRINTL 誰に使いますか？
	FOR LOCAL:1, 0, CHARANUM
		SIF NO:(LOCAL:1) == 149 && CFLAG:(LOCAL:1):75 < 3 && !TALENT:MASTER:禁断の知識
			CONTINUE
		SIF TALENT:(LOCAL:1):妊娠
			CONTINUE
		SIF GETBIT(TALENT:(LOCAL:1):2,0) && CFLAG:(LOCAL:1):81 != 3
			PRINTFORML [{LOCAL:1}] - %CALLNAME:(LOCAL:1)% 
	NEXT
	PRINTL [999] - 戻る
	$INPUT_LOOP_92
	INPUT
	IF RESULT == 999
		RESTART
	ELSEIF RESULT >= CHARANUM || !GETBIT(TALENT:RESULT:2,0)
		GOTO INPUT_LOOP_92
	ELSE
		PRINTFORM %CALLNAME:RESULT%
		IF RESULT == 0
			PRINTW はピルを飲みました
		ELSE
			PRINTW にピルを渡しました
		ENDIF
		MONEY -= ITEMPRICE:LOCAL
		CFLAG:RESULT:81 = 3
	ENDIF
	RESTART
ENDIF

IF LOCAL == 93
	CALL CHOICE("【虹色のキャンディ】を購入しますか？", "はい", "いいえ")
	SIF RESULT
		RESTART
	PRINTL 誰に使いますか？
	PRINTL [-1] - 戻る
	FOR LOCAL:1, 0, CHARANUM
		SIF !TALENT:(LOCAL:1):恋慕
			PRINTFORML [{LOCAL:1}] - %CALLNAME:(LOCAL:1)% 
	NEXT
	$INPUT_LOOP_93
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || TALENT:RESULT:3
		GOTO INPUT_LOOP_93
	ELSE
		PRINTFORMW %CALLNAME:RESULT%は[恋慕]を得ました
		MONEY -= ITEMPRICE:LOCAL
		TALENT:RESULT:NTR = 0
		TALENT:RESULT:公衆便所 = 0
		TALENT:RESULT:恋慕 = 1
	ENDIF
	RESTART
ENDIF

IF LOCAL == 94
	CALL CHOICE("【黒いキャンディ】を購入しますか？", "はい", "いいえ")
	SIF RESULT
		RESTART
	PRINTL 誰に使いますか？
	PRINTL [-1] - 戻る
	FOR LOCAL:1, 0, CHARANUM
		SIF !TALENT:(LOCAL:1):NTR
			PRINTFORML [{LOCAL:1}] - %CALLNAME:(LOCAL:1)% 
	NEXT
	$INPUT_LOOP_94
	INPUT
	IF RESULT == -1
		RESTART
	ELSEIF RESULT <= -1 || RESULT >= CHARANUM || TALENT:RESULT:6
		GOTO INPUT_LOOP_94
	ELSE
		PRINTFORMW %CALLNAME:RESULT%は[NTR]を得ました
		MONEY -= ITEMPRICE:LOCAL
		TALENT:RESULT:恋慕 = 0
		TALENT:RESULT:NTR = 1
	ENDIF
	RESTART
ENDIF

IF LOCAL == 41
	MONEY -= ITEMPRICE:LOCAL
	ITEM:LOCAL ++
	PRINTW 媚薬を精製しました
	RESTART
ENDIF
;複数所持アイテム
SELECTCASE LOCAL
	CASE 40 TO 60, 91, 92,
		PRINTFORM %ITEMNAME:LOCAL%をいくつ購入しますか？
		SIF LOCAL == 50
			PRINTFORM (あと{ITEMSALES:LOCAL}個)
		PRINTFORML 
		;金欠、アイテム数の超過はあとで合わせる
		PRINTL [0] - やめる
		PRINT [1] - 1　
		PRINT [5] - 5　
		PRINT [10] - 10　
		PRINT [20] - 20　
		PRINT [50] - 50　
		PRINT [999] - 買えるだけ
		INPUT
		SIF RESULT <= 0
			RESTART
		SIF RESULT * ITEMPRICE:LOCAL > MONEY
			RESULT = MONEY / ITEMPRICE:LOCAL
		;個数限定
		IF ITEMSALES:LOCAL
			IF RESULT >= ITEMSALES:LOCAL
				RESULT = ITEMSALES:LOCAL
				ITEMSALES:LOCAL = -1
			ELSE
				ITEMSALES:LOCAL -= RESULT
			ENDIF
		ELSE
			ITEM:LOCAL += RESULT
			IF ITEM:LOCAL > 999
				RESULT = 999 - (ITEM:LOCAL - RESULT)
				ITEM:LOCAL = 999
			ENDIF
		ENDIF
		PRINTFORMW %ITEMNAME:LOCAL%を{RESULT}個、${RESULT * ITEMPRICE:LOCAL}で購入しました
		MONEY -= RESULT * ITEMPRICE:LOCAL
		RESTART
;単品アイテム
	CASE 0 TO 39
		PRINTFORML %ITEMNAME:LOCAL%を購入しますか？
		PRINTL [0] - はい  [1] - いいえ
		INPUT
		SIF RESULT
			RESTART
		ITEM:LOCAL ++
		ITEMSALES:LOCAL --
		MONEY -= ITEMPRICE:LOCAL
		RESTART
ENDSELECT

@SHOW_ITEM
DRAWLINE
LOCAL:2 = 0
FOR LOCAL,0,100
	;表示しない
	SIF ITEMSTOCK(LOCAL) == 1
		CONTINUE
	SIF ITEMSTOCK(LOCAL) == 4
		CONTINUE
	LOCALS = [{LOCAL}]%ITEMNAME:(LOCAL)% (${ITEMPRICE:(LOCAL)})
	;売り切れ
	IF ITEMSTOCK(LOCAL) == 2
		LOCALS = [{LOCAL}]%ITEMNAME:LOCAL% (売切)
		SETCOLOR 150,150,150
	ELSEIF ITEMSTOCK(LOCAL) == 5
		LOCALS = [{LOCAL}]%ITEMNAME:LOCAL%
		SETCOLOR 150,150,150
	ENDIF
	PRINTFORM %LOCALS,28,LEFT%
	RESETCOLOR
	LOCAL:2 += 1
	SIF LOCAL:2 % 3 == 0
		PRINTL
NEXT
PRINTL

;条件付きアイテムの処理
@ITEM_SALES
;ITEMSALES = 0 購入可
;ITEMSALES = -1 売切
;ITEMSALES = -2 封印
;技巧
IF ABL:MASTER:技巧 < 5
	ITEMSALES:63 = 0
ELSE
	ITEMSALES:63 = -2
ENDIF
IF ABL:MASTER:技巧
	ITEMSALES:64 = 0
ELSE
	ITEMSALES:64 = -2
ENDIF

SIF TALENT:MASTER:禁断の知識
	ITEMSALES:62 = -1
SIF TALENT:MASTER:調合知識
	ITEMSALES:61 = -1
SIF TALENT:MASTER:汚臭耐性 == 2
	ITEMSALES:60 = -1
;媚薬
IF ABL:MASTER:教養 < 1
	ITEMSALES:41 = -2
ELSE
	IF ITEM:41
		ITEMSALES:41 = -1
	ELSE
		ITEMSALES:41 = 0
	ENDIF
ENDIF
;禁断
FOR LOCAL,70,100
	;売切の場合はそのまま
	SIF ITEMSALES:LOCAL == -1
		CONTINUE
	ITEMSALES:LOCAL = -2
	;禁断の知識
	IF (LOCAL > 70 && LOCAL < 89) || LOCAL == 90
		SIF TALENT:MASTER:禁断の知識 || (ASSI > 0 && TALENT:ASSI:禁断の知識)
			ITEMSALES:LOCAL = 0
	;調合知識
	ELSEIF LOCAL == 70 || LOCAL == 91 || LOCAL == 92 || LOCAL == 93 || LOCAL == 94
		SIF TALENT:MASTER:調合知識 || (ASSI > 0 && TALENT:ASSI:調合知識)
			ITEMSALES:LOCAL = 0
	ENDIF
NEXT

